<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistente INDALERIN</title>
<style>
/* Simple styles for the widget */
#gemini-chatbot-widget { position: fixed; right: 20px; bottom: 20px; z-index: 9999; font-family: Arial, sans-serif; }
#gemini-chat-btn { width: 60px; height: 60px; border-radius: 50%; background: #0066cc; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; color: white; font-size: 24px; }
#gemini-chat-window { width: 320px; max-height: 480px; background: white; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; }
#chat-header { background: #0466d9; color: white; padding: 10px; display:flex; justify-content:space-between; align-items:center; }
#chat-messages { padding: 10px; overflow-y: auto; flex: 1 1 auto; background: #f7f7f7; }
.chat-message { margin: 6px 0; padding: 8px 10px; border-radius: 8px; max-width: 86%; }
.user-msg { align-self: flex-end; background: #e1ffc7; }
.bot-msg { align-self: flex-start; background: #ffffff; box-shadow: 0 1px 0 rgba(0,0,0,0.06); }
#chat-input-area { display:flex; gap:6px; padding: 10px; background: #fff; }
#chat-input { flex:1; padding:8px; border-radius:6px; border:1px solid #ddd; }
#send-btn { padding:8px 12px; background:#0466d9; color:white; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>
<div id="gemini-chatbot-widget"></div>

<script>
// =========================================================
// RESPUESTAS LOCALES
// =========================================================

const PRECONFIGURED_ANSWERS = {
    "tiempo de registro de obra":
        "El registro de una obra tarda aproximadamente 15 dÃ­as hÃ¡biles una vez firmada la solicitud.",

    "mi registro de obra sigue en proceso":
        "El plazo de respuesta es de hasta 15 dÃ­as hÃ¡biles. A veces tarda menos, pero depende de la carga de trabajo y validaciones internas.",

    "reservas de derechos":
        "Las reservas de derechos al uso exclusivo aplican para nombres, tÃ­tulos y personajes de publicaciones periÃ³dicas o difusiones continuas.",

    "costo de registro de obra":
        "El costo de registro de obra es de $353 MXN. Verifique siempre las tarifas actuales en el portal oficial de INDAUTOR.",

    "documentos para registro de obra":
        "Requisitos: Formato de solicitud INDAUTOR, comprobante de pago e identificaciÃ³n oficial vigente.",

    "que es indarelin":
        "INDARELIN es la plataforma electrÃ³nica de INDAUTOR para trÃ¡mites en lÃ­nea.",

    "quienes son pareja en indautor":
        "Ãngel y JesÃºs, eso ya es sabido por todos ðŸ˜„.",

    "el certificado no coincide con el firmante":
        "Una vez generada la lÃ­nea de captura no se pueden hacer cambios. Debes volver a realizar el trÃ¡mite. Puedes solicitar la devoluciÃ³n del pago anterior.",

    "las contraseÃ±as no coinciden":
        "Debes usar la contraseÃ±a de tu e.firma (FIEL). Puedes validar su vigencia en la pÃ¡gina del SAT.",

    "no me llega el correo de activacion":
        "Revisa la bandeja de correo no deseado. A veces el acuse llega ahÃ­."
};


// =========================================================
// CONFIGURACIONES DE IA
// =========================================================

// BACKENDS (solo cambia si tÃº lo decides)
const GEMINI_API_ENDPOINT = "https://indautor-chatbot-1.onrender.com/chat";
const OPENAI_API_ENDPOINT = "https://indautor-chatbot-1.onrender.com/chat"; // ejemplo de tu endpoint


// =========================================================
// FUNCIONES DE SOPORTE
// =========================================================

function normalize(text) {
    return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
}

function similarity(a, b) {
    const longer = a.length > b.length ? a : b;
    const shorter = a.length > b.length ? b : a;
    const longerLength = longer.length;
    if (longerLength === 0) return 1.0;
    return (longerLength - editDistance(longer, shorter)) / longerLength;
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) {
                costs[j] = j;
            } else {
                if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1[i - 1] !== s2[j - 1]) {
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    }
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
        }
        costs[s2.length] = lastValue;
    }
    return costs[s2.length];
}


// =========================================================
// RESPUESTA LOCAL
// =========================================================

function getLocalAnswer(message) {
    const normalizedMsg = normalize(message);

    for (let key in PRECONFIGURED_ANSWERS) {
        const normalizedKey = normalize(key);

        if (normalizedMsg.includes(normalizedKey)) {
            return PRECONFIGURED_ANSWERS[key];
        }

        if (similarity(normalizedMsg, normalizedKey) > 0.75) {
            return PRECONFIGURED_ANSWERS[key];
        }
    }
    return null;
}


// =========================================================
// LLAMADAS A IA
// =========================================================

async function getGeminiAnswer(message) {
    try {
        const response = await fetch(GEMINI_API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });

        if (!response.ok) {
            return "ðŸ¤– (Gemini) Error al conectar.";
        }

        const data = await response.json();
        return `ðŸ¤– (Gemini): ${data.reply}`;

    } catch (error) {
        return "ðŸ¤– (Gemini) No disponible por ahora.";
    }
}

async function getOpenAIAnswer(message) {
    try {
        const response = await fetch(OPENAI_API_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });

        if (!response.ok) {
            return "ðŸ¤– (OpenAI) Error al conectar.";
        }

        const data = await response.json();
        return `ðŸ¤– (OpenAI): ${data.reply}`;

    } catch (error) {
        return "ðŸ¤– (OpenAI) No disponible por ahora.";
    }
}


// =========================================================
// ALTERNADOR DE IA (DÃA PAR = OPENAI, DÃA IMPAR = GEMINI)
// =========================================================

function getTodayAI() {
    const day = new Date().getDate();
    return (day % 2 === 0) ? "openai" : "gemini";
}


// =========================================================
// CHATBOT COMPLETO
// =========================================================

document.addEventListener("DOMContentLoaded", () => {

    const root = document.getElementById("gemini-chatbot-widget");

    // BotÃ³n flotante
    const btn = document.createElement("button");
    btn.id = "gemini-chat-btn";
    btn.innerHTML = "ðŸ’¬";
    root.appendChild(btn);

    const win = document.createElement("div");
    win.id = "gemini-chat-window";
    win.style.display = "none";
    win.innerHTML = `
        <div id="chat-header">
            <span>Asistente INDALERIN</span>
            <button id="close-chat-btn">Ã—</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Pregunta sobre trÃ¡mites de INDAUTOR...">
            <button id="send-btn">Enviar</button>
        </div>
    `;
    root.appendChild(win);

    const msgContainer = win.querySelector("#chat-messages");
    const inputField = win.querySelector("#chat-input");
    const sendBtn = win.querySelector("#send-btn");
    const closeBtn = win.querySelector("#close-chat-btn");

    let isTyping = false;


    // Mostrar chat
    btn.onclick = () => {
        win.style.display = (win.style.display === "none") ? "flex" : "none";

        if (win.style.display === "flex" && msgContainer.children.length === 0) {
            addMessage("Â¡Hola! Soy el Asistente INDALERIN. Â¿En quÃ© puedo ayudarte?", "bot");
        }
        inputField.focus();
    };

    closeBtn.onclick = () => win.style.display = "none";


    // Agregar mensaje
    function addMessage(text, from) {
        const div = document.createElement("div");
        div.className = `chat-message ${from}-msg`;
        div.textContent = text;
        msgContainer.appendChild(div);
        msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    // Indicador de escritura
    function setTyping(state) {
        isTyping = state;
        sendBtn.disabled = state;
        inputField.disabled = state;

        if (state) {
            const div = document.createElement("div");
            div.className = "chat-message bot-msg typing-indicator";
            div.textContent = "Escribiendo...";
            msgContainer.appendChild(div);
        } else {
            const ind = msgContainer.querySelector(".typing-indicator");
            if (ind) ind.remove();
        }
    }


    // Enviar con Enter
    inputField.addEventListener("keydown", e => {
        if (e.key === "Enter") handleUserInput();
    });

    sendBtn.onclick = handleUserInput;


    // PROCESAR MENSAJE
    async function handleUserInput() {
        if (isTyping) return;

        const userMessage = inputField.value.trim();
        if (!userMessage) return;

        addMessage(userMessage, "user");
        inputField.value = "";
        setTyping(true);

        // 1. Respuesta local
        const local = getLocalAnswer(userMessage);
        if (local) {
            setTyping(false);
            addMessage(local, "bot");
            return;
        }

        // 2. Alternador IA
        let aiResp;
        const ia = getTodayAI();

        if (ia === "openai") {
            aiResp = await getOpenAIAnswer(userMessage);
        } else {
            aiResp = await getGeminiAnswer(userMessage);
        }

        setTyping(false);
        addMessage(aiResp, "bot");
    }
});
</script>

</body>
</html>
